<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroTutor V4 - AI-Powered Microbiology Education</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>🔬 MicroTutor V4</h1>
            <p class="subtitle">AI-Powered Microbiology Education</p>
        </header>

        <div class="instructions">
            <h2>📋 Case Flow</h2>
            <ol>
                <li><strong>Information Gathering:</strong> Gather key history and examination findings from the patient
                </li>
                <li><strong>Differential Diagnosis & Clinical Reasoning:</strong> Organize clinical information and
                    develop differential diagnoses</li>
                <li><strong>Tests & Management:</strong> Order relevant investigations and propose treatments</li>
                <li><strong>Feedback:</strong> Receive feedback on the case</li>
            </ol>
        </div>


        <div class="case-setup">
            <div class="setup-row">
                <div class="setup-group">
                    <label for="organism-select">Select Organism:</label>
                    <select id="organism-select">
                        <option value="">-- Choose an organism --</option>
                        <option value="random">🎲 Random (No Repeats)</option>
                        <optgroup label="Bacteria">
                            <option value="staphylococcus aureus">Staphylococcus aureus</option>
                            <option value="escherichia coli">Escherichia coli</option>
                            <option value="nocardia species">Nocardia species</option>
                            <option value="borrelia burgdorferi">Borrelia burgdorferi</option>
                            <option value="streptococcus pneumoniae">Streptococcus pneumoniae</option>
                        </optgroup>
                        <optgroup label="Viruses">
                            <option value="hsv-1">HSV-1</option>
                            <option value="influenza a">Influenza A</option>
                            <option value="hiv">HIV</option>
                            <option value="ebv">EBV</option>
                        </optgroup>
                        <optgroup label="Fungi">
                            <option value="candida albicans">Candida albicans</option>
                            <option value="aspergillus fumigatus">Aspergillus fumigatus</option>
                        </optgroup>
                        <optgroup label="Parasites">
                            <option value="plasmodium falciparum">Plasmodium falciparum (malaria)</option>
                            <option value="taenia solium">Taenia solium</option>
                        </optgroup>
                    </select>

                    <!-- Guidelines Toggle (inline with organism selection) -->
                    <label class="guidelines-toggle-inline">
                        <input type="checkbox" id="guidelines-toggle" disabled>
                        <span class="toggle-slider-mini"></span>
                        <span class="toggle-label-mini">📚 Fetch Guidelines</span>
                    </label>
                </div>

                <div class="setup-group">
                    <label for="model-provider">Model Provider:</label>
                    <div class="model-provider-toggle">
                        <input type="radio" id="azure-provider" name="model-provider" value="azure" checked>
                        <label for="azure-provider">Azure</label>
                        <input type="radio" id="personal-provider" name="model-provider" value="personal">
                        <label for="personal-provider">Personal</label>
                    </div>
                </div>

                <div class="setup-group">
                    <label for="model-select">Select Model:</label>
                    <select id="model-select">
                        <!-- Options will be dynamically populated based on provider selection -->
                    </select>
                </div>
            </div>

            <div class="setup-actions">
                <button id="start-case-btn" class="btn btn-primary">🚀 Start New Case</button>
            </div>
        </div>

        <!-- Guidelines Results Display (only shown when toggle is on and guidelines are fetched) -->
        <div id="guidelines-results" class="guidelines-results" style="display: none;">
            <div class="guidelines-header">
                <h4>📋 Clinical Guidelines</h4>
                <div class="guidelines-status">
                    <span id="guidelines-status" class="status-indicator">⏳ Loading...</span>
                    <span id="guidelines-count" class="count-badge">0 results</span>
                </div>
            </div>
            <div id="guidelines-content" class="guidelines-content">
                <!-- Guidelines will be populated here -->
            </div>
        </div>

        <!-- Feedback Controls -->
        <div class="feedback-controls">
            <h3>🎯 Feedback System Controls</h3>
            <div class="control-group">
                <label class="toggle-container">
                    <input type="checkbox" id="feedback-toggle" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Enable AI Feedback</span>
                </label>
            </div>
            <div class="control-group">
                <label for="threshold-slider">Similarity Threshold: <span id="threshold-value">0.7</span></label>
                <input type="range" id="threshold-slider" min="0.1" max="1.0" step="0.1" value="0.7" class="slider">
                <div class="threshold-labels">
                    <span>0.1 (More Examples)</span>
                    <span>1.0 (Exact Matches Only)</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Chat Area -->
            <div class="chat-container">
                <div id="chatbox" class="chatbox">
                    <div class="welcome-message">
                        <p>👋 Welcome to MicroTutor V4!</p>
                        <p>Select an organism above and click "Start New Case" to begin your interactive microbiology
                            case
                            study.</p>
                    </div>
                </div>

                <div id="input-area" class="input-area">
                    <textarea id="user-input" placeholder="Enter your message or use voice..." rows="1"
                        disabled></textarea>
                    <div class="button-group">
                        <button id="voice-btn" class="btn btn-voice" title="Click to start/stop recording">
                            🎤 Voice
                        </button>
                        <button id="send-btn" class="btn btn-success" disabled>
                            <span class="btn-icon">📤</span> Send
                        </button>
                        <button id="finish-btn" class="btn btn-warning" disabled>
                            <span class="btn-icon">🏁</span> Finish Case
                        </button>
                    </div>
                    <div class="voice-controls">
                        <p id="voice-status" class="voice-status">🎤 Initializing...</p>
                        <audio id="response-audio" controls hidden></audio>
                    </div>
                </div>
            </div>

            <!-- Phase Progression Sidebar -->
            <div id="phase-progression" class="phase-progression" style="display: none;">
                <h3>🎯 Case Progress</h3>
                <div class="phase-buttons">
                    <button class="phase-btn" data-phase="information_gathering">
                        <span class="phase-icon">📋</span>
                        <span class="phase-text">Information Gathering</span>
                    </button>
                    <button class="phase-btn" data-phase="differential_diagnosis">
                        <span class="phase-icon">🔍</span>
                        <span class="phase-text">Differential Diagnosis & Clinical Reasoning</span>
                    </button>
                    <button class="phase-btn" data-phase="tests_management">
                        <span class="phase-icon">🧪</span>
                        <span class="phase-text">Tests & Management</span>
                    </button>
                    <button class="phase-btn" data-phase="feedback">
                        <span class="phase-icon">✅</span>
                        <span class="phase-text">Feedback</span>
                    </button>
                </div>
                <div class="phase-guidance">
                    <p id="phase-guidance-text">Start by gathering patient history and examination findings.</p>
                </div>
            </div>
        </div>

        <p id="status-message" class="status"></p>

        <!-- Compact Feedback Dashboard -->
        <div id="feedback-dashboard" class="feedback-dashboard compact">
            <div class="dashboard-header">
                <h3>📊 Live Feedback Analytics</h3>
                <div class="dashboard-controls">
                    <button id="refresh-stats-btn" class="btn btn-secondary">🔄 Refresh</button>
                    <label class="auto-refresh-toggle">
                        <input type="checkbox" id="auto-refresh-toggle" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Auto-refresh (30s)</span>
                    </label>
                </div>
            </div>

            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">💬</div>
                    <div class="stat-content">
                        <div class="stat-label">Message Feedback</div>
                        <div id="message-feedback-count" class="stat-value">Loading...</div>
                        <div class="stat-trend" id="message-trend">+0 today</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📋</div>
                    <div class="stat-content">
                        <div class="stat-label">Case Feedback</div>
                        <div id="case-feedback-count" class="stat-value">Loading...</div>
                        <div class="stat-trend" id="case-trend">+0 today</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-content">
                        <div class="stat-label">Avg Rating</div>
                        <div id="avg-rating" class="stat-value">Loading...</div>
                        <div class="stat-trend" id="rating-trend">+0.0 vs yesterday</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🕒</div>
                    <div class="stat-content">
                        <div class="stat-label">Last Updated</div>
                        <div id="last-updated" class="stat-value">Never</div>
                        <div class="stat-trend" id="update-trend">System active</div>
                    </div>
                </div>
                <div class="stat-card faiss-status-card">
                    <div class="stat-icon" id="faiss-icon">🔄</div>
                    <div class="stat-content">
                        <div class="stat-label">FAISS Index</div>
                        <div id="faiss-status" class="stat-value">Ready</div>
                        <div class="stat-trend" id="faiss-trend">Last update: Never</div>
                    </div>
                    <div id="faiss-loading" class="faiss-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span class="loading-text">Re-indexing...</span>
                    </div>
                </div>
            </div>

            <!-- Feedback Trends Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h4>📈 Feedback Trends Over Time</h4>
                    <div class="chart-controls">
                        <button id="toggle-chart-btn" class="btn btn-small">📊 Toggle Chart</button>
                    </div>
                </div>
                <div id="feedback-chart" class="chart">
                    <canvas id="trends-canvas" width="800" height="300"></canvas>
                </div>
            </div>

        </div>

        <footer>
            <p>Powered by FastAPI & OpenAI | Version 4.0.0</p>
        </footer>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📊 Case Feedback</h2>
                <button class="modal-close" id="close-feedback-btn" aria-label="Close">×</button>
            </div>

            <div class="case-summary">
                <h3>Case Summary</h3>
                <p>The correct organism for this case was: <strong id="correct-organism"></strong></p>
            </div>

            <div class="feedback-form">
                <div class="feedback-question">
                    <p>How detailed was the case?</p>
                    <div class="likert-scale">
                        <label><input type="radio" name="detail" value="1"> 1 (Not detailed)</label>
                        <label><input type="radio" name="detail" value="2"> 2</label>
                        <label><input type="radio" name="detail" value="3"> 3</label>
                        <label><input type="radio" name="detail" value="4"> 4</label>
                        <label><input type="radio" name="detail" value="5"> 5 (Very detailed)</label>
                    </div>
                    <button class="skip-btn" data-question="detail">Skip</button>
                </div>

                <div class="feedback-question">
                    <p>How helpful was this case for your learning?</p>
                    <div class="likert-scale">
                        <label><input type="radio" name="helpfulness" value="1"> 1 (Not helpful)</label>
                        <label><input type="radio" name="helpfulness" value="2"> 2</label>
                        <label><input type="radio" name="helpfulness" value="3"> 3</label>
                        <label><input type="radio" name="helpfulness" value="4"> 4</label>
                        <label><input type="radio" name="helpfulness" value="5"> 5 (Very helpful)</label>
                    </div>
                    <button class="skip-btn" data-question="helpfulness">Skip</button>
                </div>

                <div class="feedback-question">
                    <p>How accurate was the medical information in this case?</p>
                    <div class="likert-scale">
                        <label><input type="radio" name="accuracy" value="1"> 1 (Not accurate)</label>
                        <label><input type="radio" name="accuracy" value="2"> 2</label>
                        <label><input type="radio" name="accuracy" value="3"> 3</label>
                        <label><input type="radio" name="accuracy" value="4"> 4</label>
                        <label><input type="radio" name="accuracy" value="5"> 5 (Very accurate)</label>
                    </div>
                    <button class="skip-btn" data-question="accuracy">Skip</button>
                </div>

                <div class="feedback-question">
                    <p>Additional comments (optional):</p>
                    <textarea id="feedback-comments" rows="4"
                        placeholder="Share your thoughts about this case..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button id="submit-feedback-btn" class="btn btn-success">✅ Submit Feedback</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/script.js"></script>
</body>

</html>